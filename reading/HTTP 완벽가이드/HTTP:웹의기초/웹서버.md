# 2부 5장 웹서버

### 진짜 웹 서버가 하는 일
- 커넥션을 맺는다
- 요청을 받는다
- 요청을 처리한다
- 리소스에 접근한다
- 응답을 만든다
- 응답을 보낸다
- 트랜잭션을 로그로 남긴다

### 클라이언트의 커넥션 수락
> 클라이언트가 서버에 대해 지속적으로 연결되어있는 커넥션을 갖고있다면, 클라이언트는 그 커넥션을 재사용할 수 있다.  
> 커넥션이 연결되어있지 않다면 서버와 새로운 커넥션을 맺는 과정이 필요하다. 

### 새 커넥션 다루기
- 클라이언트가 웹 서버로 TCP 커넥션을 요청하면, 웹 서버는 그 커넥션을 수락하고  IP 정보를 추출하여 클라이언트 정보를 확인한다.  
- 새 커넥션이 맺어지면 웹 서버는 연결된 커넥션을 커넥션 목록에 추가하고 데이터를 송수신하기 위한 준비를 한다.
- 웹 서버는 커넥션을 거부하거나 종료할 수 있다. IP 주소나 호스트명이 인가되지 않은 경우 악의적인 커넥션으로 판단하여 거부하거나 커넥션을 닫는다. 

### ident를 통해 클라이언트 사용자 알아내기
> 몇몇 웹 서버는 IETF ident 프로토콜을 지원한다. ident 프로토콜은 어떤 사용자가 HTTP 커넥션을 요청하였는지 식별할 수 있다.  
> ident 정보는 로깅에 유용하기 때문에 널리 쓰이는 일반 로그 포맷의 두 번째 필드는 각 HTTP 요청의 ident 사용자 이름을 담고있다.

**단점**
- ident 정보를 확인하는 절차가 HTTP 트랜잭션을 지연시킬 수 있다.
- 많은 클라이언트가 ident 신원확인 프로로콜 데몬 소프트웨어를 사용하지 않는다.
- ident 프로토콜은 가상 IP 주소를 잘 지원하지 않는다.
- ident 프로토콜은 조작하기 쉽다는 점 때문에 안전하지 않다.
- 클라이언트 사용자 이름 노출로 인해 프라이버시 침해의 우려가 있다.


### 요청 메시지 수신
- 요청라인을 파싱하여 요청 메서드, 리소스 식별자, 버전 번호를 찾는다. 각 값은 스페이스로 분리되어 있다. 요청줄은 캐리지 문자열로 끝난다.
- 메시지 헤더를 읽는다.헤더도 마찬가지로 캐리지 문자열로 끝난다.
- 헤더의 끝을 의미하는 캐리지 문자열을 찾아낸다. 
- 요청 본문을 읽어들인다. 요청 본문의 길이는 Content-Length 헤더로 정의된다. 

웹 서버는 요청 메시지를 파싱해서 이해하는 것이 가능한 수준의 분량을 확보할 때까지 메시지 일부분을 메모리에 임시로 저장해둔다. 

### 커넥션 입력/출력 처리 아키텍처
- 고성능 웹 서버는 수천 개의 커넥션을 동시에 열 수 있도록 지원한다.
- 웹 서버들은 항상 새 요청을 주시하고 있다. 요청은 언제라도 도착할 수 있기 때문이다. 
- 웹 서버의 아키텍처에 따라 요청을 처리하는 방식도 달라진다.

### 단일 스레드 웹 서버
- 단일 스레드 웹 서버는 요청을 하나씩 처리한다. 트랜잭션이 완료되면 다음 요청을 처리하는 것이다.
- 단일 스레드 웹 서버는 구현하기 간단하다는 장점이 있지만, 요청 처리 도중에 다른 커넥션은 무시된다.
- 단일 스레드 웹 서버는 type-o-server나 로드가 적은 서버에 적당하다.

### 멀티프로세스와 멀티스레드 웹 서버
- 스레드와 프로세스는 필요할 때마다 만들어질 수도 있고, 미리 만들어놀 수도 있다.
- 대용량 요청을 처리하기 위해 스레드를 매번 생성하면 서버의 메모리가 부족한 상황이 발생할 수 있다.
  - 이를 방지하기 위해 많은 멀티스레드 웹 서버는 스레드/프로세스 개수 제한을 건다.

### 다중 I/O 서버
- 대량의 커넥션을 지원하기 위해 많은 웹 서버는 다중 아키텍처를 채택했다.
- 다중 아키텍처에서는, 모든 커넥션이 동시에 활동을 감시당한다. 
- 커넥션의 상태가 바뀌면, 해당 커넥션에 대한 처리를 수행하고 이는 다시 커넥션 목록으로 돌아간다.
  - 커넥션 풀과 비슷하게 이해하면 될 것 같다. 처리가 완료된 커넥션이 커넥션풀에 반환되는 과정을 설명하는 문장 같다.
- 특정 커넥션에 대해 작업을 수행하는 것은, 커넥션이 해야할 일이 있을 때 뿐이다. 
  - 스레드와 프로세스는 유휴 상태의 커넥션에 매여 리소스를 낭비하지 않는다. 

### 다중 멀티스레드 웹 서버
- 멀티 프로세서의 이점을 살리기 위해 멀티스레딩과 멀티플렉싱을 결합한다.
- 여러 스레드는 각 커넥션에 대한 감시를 수행하고, 커넥션에 대한 작업을 수행한다.

### 서버사이드 인클루드
- 많은 웹 서버가 서버사이드 인클루드를 지원한다. 특정 리소스가 이를 포함한다면, 리소스 콘텐츠를 클라이언트에게 보내기전에 처리한다.
- 서버는 콘텐츠에 변수 이름이나 내장된 스크립트가 존재하는지 검사한다. 이는 변수의 값이나 실행가능한 스크립트의 출력값으로 치환한다.
  - 동적 콘텐츠를 만드는 방법
- 서버 사이드 렌더링과는 미세한 차이가 있음
  - SSI 같은 경우엔 jsp의 include 태그를 이용할 때 서버에서 미리 조합해서 전송하는 것을 의미하는 듯